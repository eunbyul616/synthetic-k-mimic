import os
import numpy as np
import pandas as pd
from typing import List

from sklearn.neighbors import NearestNeighbors
from sklearn.metrics import accuracy_score


def membership_inference_attack(train_data: np.array,
                                holdout_data: np.array,
                                synthetic_data: np.array,
                                k: int=5,
                                threshold: float=0.5,
                                n_jobs: int=-1) -> float:
    """
    Evaluates the risk of membership inference attacks on synthetic data by using a k-Nearest Neighbors (kNN)
    classifier. The function trains a kNN model on synthetic data, and uses the model to predict
    whether a given real data sample belongs to the training set.

    Args:
        train_data: training data, which is part of the real data.
        holdout_data: holdout data, which is part of the real data.
        synthetic_data: synthetic data generated by the model.
        k: the number of neighbors to use for the knn model. Default is 5.
        threshold: threshold for predicting if a data point belongs to the training set.
                The prediction is made based on the minimum distance being less than or equal to this threshold.
                Defaults to 0.5.
        n_jobs: the number of parallel jobs to run for the knn model. Default is -1.

    Returns:
        acc: the accuracy of the membership inference attack.

    Notes:
        - The real data is assumed to consist of both training and holdout data, with labels 1 for training data and 0 for holdout data.
        - The kNN model is trained on synthetic data and tested on real data to identify whether the real data point was part of the training data.
        - If the Privacy leakage is high, the kNN model will have a higher accuracy (> 50%).
        - In an ideal case, the accuracy would be close to 50%, as the model would not be able to distinguish between training and holdout data.
    """

    real_data = np.vstack((train_data, holdout_data))
    labels = np.concatenate((np.ones(len(train_data)), np.zeros(len(holdout_data))))

    # train kNN model fitted on the synthetic data
    nn_model = NearestNeighbors(n_neighbors=k, metric='hamming', n_jobs=n_jobs)
    nn_model.fit(synthetic_data, np.ones(len(synthetic_data)))

    distances, _ = nn_model.kneighbors(real_data)
    min_distances = np.min(distances, axis=1)
    pred = (min_distances <= threshold).astype(int)

    acc = accuracy_score(labels, pred)
    print('Membership Inference Attacks Accuracy: ', np.round(acc, 3))

    return acc


if __name__ == "__main__":
    train_data = np.random.rand(50, 10)
    holdout_data = np.random.rand(50, 10)
    synthetic_data = np.random.rand(50, 10)

    acc = membership_inference_attack(train_data, holdout_data, synthetic_data)
    print(acc)